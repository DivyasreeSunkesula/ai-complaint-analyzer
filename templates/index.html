<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>AI Complaint Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    header { display:flex; justify-content:space-between; align-items:center; }
    h1 { margin: 0; }
    .controls { display:flex; gap:12px; margin-top:12px; align-items:center; flex-wrap:wrap; }
    textarea { width: 480px; height:70px; }
    button { padding:8px 12px; }
    .filters { display:flex; gap:12px; align-items:center; margin-top:12px; }
    table { width:100%; border-collapse:collapse; margin-top:18px; }
    th, td { padding:8px; border:1px solid #ddd; text-align:left; }
    th { background:#f6f6f6; }
    .small { font-size:13px; color:#666; }
    .charts { display:flex; gap:20px; margin-top:18px; align-items:center; }
    .chart-card { width:320px; padding:12px; border:1px solid #eee; border-radius:6px; background:#fff; }
    .pagination { margin-top:12px; display:flex; gap:8px; align-items:center; }
    @media(max-width:900px){ textarea{width:100%} .charts{flex-direction:column} }

    /* priority colors (same as earlier) */
    .priority-critical { background-color: #ffcccc; }
    .priority-high { background-color: #ffe0b3; }
    .priority-medium { background-color: #ffffcc; }
    .priority-low { background-color: #ccffcc; }

    .status-in-progress { background-color: #e8f2ff; }
    .status-resolved { background-color: #e6f4ea; }
  </style>
</head>
<body>
  <header>
    <h1>AI Complaint Dashboard</h1>
    <div class="small">Service: ai-complaint-analyzer</div>
  </header>

  <section class="controls">
    <div>
      <h3>Submit New Complaint</h3>
      <textarea id="complaintText" placeholder="Enter complaint here"></textarea><br/>
      <button onclick="submitComplaint()">Submit</button>
      <button onclick="exportCSV()" style="margin-left:8px">Export CSV</button>
    </div>

    <div>
      <h3>Search & Filters</h3>
      <div class="filters">
        <input id="searchInput" placeholder="search doc_id, category, summary..." style="width:260px"/>
        <select id="filterStatus">
          <option value="">All Status</option><option>New</option><option>In-Progress</option><option>Resolved</option>
        </select>
        <select id="filterPriority">
          <option value="">All Priority</option><option>Critical</option><option>High</option><option>Medium</option><option>Low</option>
        </select>
        <label class="small">Page size:
          <select id="pageSize"><option>10</option><option selected>25</option><option>50</option></select>
        </label>
      </div>

      <div class="pagination">
        <button id="prevBtn" onclick="prevPage()">Previous</button>
        <span class="small">Page <span id="pageNum">1</span> / <span id="pageCount">1</span> â€” <span id="totalCount">0</span> items</span>
        <button id="nextBtn" onclick="nextPage()">Next</button>
      </div>
    </div>
  </section>

  <!-- TABLE ON TOP -->
  <section>
    <table id="complaintsTable">
      <thead>
        <tr>
          <th>Doc ID</th>
          <th>Category</th>
          <th>Summary</th>
          <th>Priority</th>
          <th>Status</th>
          <th>Suggested Action</th>
          <th>Created At</th>
          <th>Update Priority</th>
          <th>Update Status</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

  <!-- CHARTS BELOW -->
  <section class="charts" style="margin-top:24px;">
    <div class="chart-card">
      <h4 style="margin-top:0">By Category</h4>
      <canvas id="catChart" width="320" height="240"></canvas>
    </div>
    <div class="chart-card">
      <h4 style="margin-top:0">By Priority</h4>
      <canvas id="priorityChart" width="320" height="240"></canvas>
    </div>
  </section>

<script>
  // client state
  let page = 1;
  let pageSize = parseInt(document.getElementById("pageSize").value || "25");
  let pageCount = 1;

  // DOM refs
  const searchInput = document.getElementById("searchInput");
  const filterStatus = document.getElementById("filterStatus");
  const filterPriority = document.getElementById("filterPriority");
  const pageSizeEl = document.getElementById("pageSize");
  const pageNumEl = document.getElementById("pageNum");
  const pageCountEl = document.getElementById("pageCount");
  const totalCountEl = document.getElementById("totalCount");
  const prevBtn = document.getElementById("prevBtn");
  const nextBtn = document.getElementById("nextBtn");

  // charts
  let catChart = null;
  let priorityChart = null;

  function buildQuery() {
    const q = encodeURIComponent(searchInput.value || "");
    const status = encodeURIComponent(filterStatus.value || "");
    const priority = encodeURIComponent(filterPriority.value || "");
    pageSize = parseInt(pageSizeEl.value || "25");
    return `/complaints?q=${q}&status=${status}&priority=${priority}&page=${page}&page_size=${pageSize}&sort_by=created_at&sort_dir=desc`;
  }

  async function fetchPage() {
    const url = buildQuery();
    const res = await fetch(url);
    if (!res.ok) {
      console.error("Failed to fetch /complaints", res.statusText);
      return;
    }
    const data = await res.json();
    pageNumEl.innerText = data.page;
    const total = data.total || 0;
    totalCountEl.innerText = total;
    pageCount = Math.max(1, Math.ceil(total / (data.page_size || pageSize)));
    pageCountEl.innerText = pageCount;
    // disable/enable buttons
    prevBtn.disabled = data.page <= 1;
    nextBtn.disabled = data.page >= pageCount;

    renderTable(data.items);
    await refreshCharts();
  }

  function renderTable(items) {
    const tbody = document.querySelector("#complaintsTable tbody");
    tbody.innerHTML = "";
    items.forEach(item => {
      const tr = document.createElement("tr");

      // colors by priority & status
      if (item.priority) tr.classList.add("priority-" + (item.priority || "").toLowerCase());
      if (item.status && item.status === "In-Progress") tr.classList.add("status-in-progress");
      if (item.status && item.status === "Resolved") tr.classList.add("status-resolved");

      tr.innerHTML = `
        <td>${item.doc_id || ""}</td>
        <td>${item.category || ""}</td>
        <td>${item.summary || ""}</td>
        <td>${item.priority || ""}</td>
        <td>${item.status || ""}</td>
        <td>${item.suggested_action || ""}</td>
        <td>${new Date(item.created_at || "").toLocaleString() || ""}</td>
        <td></td>
        <td></td>
      `;

      // priority select
      const pSelect = document.createElement("select");
      ["Critical","High","Medium","Low"].forEach(p => {
        const opt = document.createElement("option"); opt.value = p; opt.text = p;
        if (p === item.priority) opt.selected = true;
        pSelect.appendChild(opt);
      });
      pSelect.onchange = () => updatePriority(item.doc_id, pSelect.value);
      tr.cells[7].appendChild(pSelect);

      // status select
      const sSelect = document.createElement("select");
      ["New","In-Progress","Resolved"].forEach(s => {
        const opt = document.createElement("option"); opt.value = s; opt.text = s;
        if (s === item.status) opt.selected = true;
        sSelect.appendChild(opt);
      });
      sSelect.onchange = () => updateStatus(item.doc_id, sSelect.value);
      tr.cells[8].appendChild(sSelect);

      tbody.appendChild(tr);
    });
  }

  async function submitComplaint() {
    const text = document.getElementById("complaintText").value.trim();
    if (!text) return alert("Enter complaint");
    await fetch("/submit", { method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify({complaint: text})});
    document.getElementById("complaintText").value = "";
    page = 1;
    fetchPage();
  }

  async function updateStatus(doc_id, status) {
    await fetch("/update_status", { method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify({doc_id, status})});
    fetchPage();
  }

  async function updatePriority(doc_id, priority) {
    await fetch("/update_priority", { method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify({doc_id, priority})});
    fetchPage();
  }

  function prevPage(){ if (page>1) { page--; fetchPage(); } }
  function nextPage(){ if (page < pageCount) { page++; fetchPage(); } }

  async function exportCSV(){
    const status = encodeURIComponent(filterStatus.value || "");
    const priority = encodeURIComponent(filterPriority.value || "");
    const url = `/export?status=${status}&priority=${priority}`;
    window.location = url;
  }

  // charts
  async function refreshCharts(){
    const res = await fetch("/stats");
    if (!res.ok) return;
    const js = await res.json();
    const cat = js.by_category || {};
    const pr = js.by_priority || {};

    updatePieChart(catChart, "catChart", cat, null);
    // priority colors: critical red, high orange, medium yellow, low green
    const prColorMap = { "Critical": "#ffcccc", "High": "#ffe0b3", "Medium": "#ffffcc", "Low": "#ccffcc" };
    updatePieChart(priorityChart, "priorityChart", pr, prColorMap);
  }

  function updatePieChart(chartRef, canvasId, dataMap, colorMap){
    const labels = Object.keys(dataMap);
    const data = labels.map(l => dataMap[l]);
    const ctx = document.getElementById(canvasId).getContext('2d');
    if (chartRef) chartRef.destroy();
    const defaultColors = labels.map((_, i) => `hsl(${(i*60)%360} 70% 60%)`);
    const colors = colorMap ? labels.map(l => colorMap[l] || "#cccccc") : defaultColors;
    const chart = new Chart(ctx, {
      type: 'pie',
      data: { labels: labels, datasets: [{ data: data, backgroundColor: colors }] },
      options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
    });
    if (canvasId === "catChart") catChart = chart;
    if (canvasId === "priorityChart") priorityChart = chart;
  }

  // wire up search / filters / page size
  searchInput.addEventListener("input", ()=>{ page = 1; fetchPage(); });
  filterStatus.addEventListener("change", ()=>{ page = 1; fetchPage(); });
  filterPriority.addEventListener("change", ()=>{ page = 1; fetchPage(); });
  pageSizeEl.addEventListener("change", ()=>{ page = 1; fetchPage(); });

  // initial load
  window.onload = () => { fetchPage(); };
</script>
</body>
</html>
